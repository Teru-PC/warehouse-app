<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>案件作成</title>

  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/calendar.css" />
</head>
<body>
  <main class="container">
    <div class="cal-topbar">
      <h1 class="cal-title">案件作成</h1>
      <div class="cal-controls" style="justify-content:flex-start;">
        <button id="backBtn" class="cal-nav-btn" type="button">戻る</button>
      </div>
    </div>

    <div id="msg" class="cal-error"></div>

    <form id="form" class="card" style="max-width:720px;">
      <label>
        タイトル（任意）
        <input id="title" type="text" placeholder="例：A社 収録" />
      </label>

      <label>
        状態
        <select id="status">
          <option value="draft" selected>draft</option>
          <option value="confirmed">confirmed</option>
          <option value="cancelled">cancelled</option>
        </select>
      </label>

      <label>
        使用開始（必須）
        <input id="start" type="datetime-local" required />
      </label>

      <label>
        使用終了（必須）
        <input id="end" type="datetime-local" required />
      </label>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
        <button type="submit">保存</button>
      </div>
    </form>
  </main>

  <script>
    (function(){
      const msg = document.getElementById("msg");
      const form = document.getElementById("form");
      const backBtn = document.getElementById("backBtn");

      function token(){ return localStorage.getItem("token") || ""; }

      function show(text){
        msg.textContent = text || "";
      }

      function getReturnUrl(){
        const u = new URL(location.href);
        return u.searchParams.get("return") || "/calendar.html?mode=week";
      }

      backBtn.addEventListener("click", ()=>{
        location.href = getReturnUrl();
      });

      if (!token()){
        location.href = "/index.html";
        return;
      }

      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        show("");

        const title = document.getElementById("title").value.trim();
        const status = document.getElementById("status").value;
        const startLocal = document.getElementById("start").value;
        const endLocal = document.getElementById("end").value;

        if (!startLocal || !endLocal){
          show("使用開始と使用終了は必須です。");
          return;
        }

        const s = new Date(startLocal);
        const en = new Date(endLocal);

        if (isNaN(s.getTime()) || isNaN(en.getTime())){
          show("日時の形式が不正です。");
          return;
        }
        if (en <= s){
          show("使用終了は使用開始より後にしてください。");
          return;
        }

        // 重要：UTC(Z)で送る
        const payload = {
          title: title || null,
          status,
          usage_start_at: s.toISOString(),
          usage_end_at: en.toISOString()
        };

        try{
          const res = await fetch("/api/projects", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token()
            },
            body: JSON.stringify(payload)
          });

          const data = await res.json().catch(()=>null);

          if (!res.ok){
            show((data && (data.message || data.error)) || "保存に失敗しました。");
            return;
          }

          // 保存後カレンダーへ戻る
          location.href = getReturnUrl();
        }catch(err){
          show("通信エラー");
        }
      });
    })();
  </script>
</body>
</html>